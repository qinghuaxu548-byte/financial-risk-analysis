# 金融风险分析系统

一个基于Python和Flask的金融风险分析系统，用于分析股票的综合风险并生成详细的分析报告。

## 功能特性

- 股票基本信息查询
- 综合风险分析
- 波动率分析
- 趋势分析
- 换手率分析
- 估值分析
- 历史估值分析
- 财务健康度分析
- RSI指标分析
- 生成风险分析报告

## 技术栈

- **后端框架**: Flask
- **金融数据API**: baostock、akshare
- **数据处理**: pandas
- **前端**: HTML、CSS、JavaScript

## 依赖环境

### Python版本要求

- Python 3.7 或更高版本

### 主要依赖库说明

| 依赖库 | 版本 | 作用 |
|--------|------|------|
| Flask | 2.3.2 | 后端Web框架，用于处理HTTP请求和响应 |
| baostock | 0.8.8 | 免费的金融数据API，提供股票历史数据、财务数据等 |
| akshare | 1.11.50 | 开源金融数据接口库，提供股票行情、行业分类等数据 |
| pandas | 1.5.3 | 强大的数据处理库，用于数据清洗、转换和分析 |
| requests | 2.31.0 | HTTP客户端库，用于发送HTTP请求 |

### 安装依赖

```bash
pip install -r requirements.txt
```

requirements.txt文件内容：
```
Flask==2.3.2
baostock==0.8.8
akshare==1.11.50
pandas==1.5.3
requests==2.31.0
```

## 技术架构

### 系统架构概述

本系统采用典型的前后端分离架构，后端负责数据获取、处理和分析，前端负责展示和交互。系统主要分为四个核心层次：

1. **前端展示层**：基于HTML、CSS和JavaScript实现，提供用户交互界面和数据可视化
2. **后端服务层**：基于Flask框架实现，处理HTTP请求、调用核心分析模块
3. **核心分析层**：包含各种金融分析算法，实现股票风险评估
4. **数据获取与存储层**：通过第三方API获取金融数据，并实现本地缓存机制

### 核心组件关系

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   前端界面      │     │   Flask应用     │     │   金融分析核心   │     │   数据获取与缓存 │
│   (index.html)  │────▶│   (app_new.py)  │────▶│   (agent.py)    │────▶│   (baostock/akshare) │
└─────────────────┘     └─────────────────┘     └─────────────────┘     └─────────────────┘
```

### 前后端交互流程

1. 用户在前端界面输入股票名称或代码，点击"分析"按钮
2. 前端通过AJAX发送POST请求到后端的`/analyze`接口
3. 后端接收请求后，调用`FinancialRiskAgent`类的相关方法：
   - 将股票名称转换为标准股票代码
   - 获取股票基本信息和行业分类
   - 调用各项分析算法进行综合风险评估
4. 后端将分析结果封装为JSON格式返回给前端
5. 前端接收数据后，更新页面显示，展示各项分析结果

### 数据流向

1. **数据获取**：通过baostock和akshare API获取股票历史数据、财务数据、行业信息等
2. **数据处理**：使用pandas对原始数据进行清洗、转换和计算
3. **数据分析**：应用各种金融分析算法，生成风险评分和评估结果
4. **数据缓存**：将部分数据缓存到本地文件系统，减少API调用次数
5. **数据展示**：将分析结果通过JSON格式返回给前端，前端进行可视化展示

### 缓存机制

系统实现了多级缓存机制，根据数据类型设置不同的缓存有效期：
- 行业分类数据：90天
- 近2年净利润：180天
- ST状态数据：1天
- 其余财务数据：90天
- 股票基本信息：1天
- 股息率：7天

缓存文件存储在项目根目录的`cache/`文件夹中，使用JSON格式保存。

## 算法原理

### 1. 综合风险评分

综合风险评分是对股票整体风险的综合评估，采用加权评分法，将各个维度的分析结果整合为一个最终得分。

**计算步骤**：
1. 分别计算波动率、趋势、换手率、估值、财务健康度和RSI指标的评分
2. 根据不同行业类型设置不同的权重系数：
   - 成长型行业：波动率(0.15)、趋势(0.15)、换手率(0.15)、估值(0.25)、财务健康度(0.20)、RSI(0.10)
   - 价值型行业：波动率(0.15)、趋势(0.15)、换手率(0.15)、估值(0.25)、财务健康度(0.20)、RSI(0.10)
   - 周期型行业：波动率(0.20)、趋势(0.15)、换手率(0.15)、估值(0.20)、财务健康度(0.25)、RSI(0.05)
3. 将各维度评分乘以对应权重后求和，得到最终综合得分
4. 根据最终得分将风险等级划分为：低风险(80-100)、较低风险(70-79)、中等风险(60-69)、较高风险(50-59)、高风险(40-49)、极高风险(0-39)

### 2. 波动率分析

波动率分析用于评估股票价格的波动程度，反映投资风险。

**计算步骤**：
1. 获取股票过去252个交易日的日收益率数据
2. 计算日收益率的标准差
3. 年化处理：将日标准差乘以√252，得到年化波动率
4. 根据波动率大小划分风险等级：
   - 低波动率：0-15%
   - 中低波动率：15-25%
   - 中等波动率：25-35%
   - 中高波动率：35-45%
   - 高波动率：>45%
5. 根据波动率等级分配对应的评分(0-100)

### 3. 趋势分析

趋势分析用于评估股票价格的整体走势，判断上涨或下跌趋势的强度。

**计算步骤**：
1. 获取股票过去252个交易日的收盘价数据
2. 计算不同时间周期(5日、20日、60日、120日)的移动平均线
3. 分析短期趋势与长期趋势的关系：
   - 短期均线上穿长期均线为金叉信号
   - 短期均线下穿长期均线为死叉信号
4. 计算趋势强度得分：
   - 根据均线排列情况评分(0-100)
   - 均线多头排列得分较高，空头排列得分较低

### 4. 换手率分析

换手率分析用于评估股票的流动性和交易活跃度，过高或过低的换手率都可能表示风险。

**计算步骤**：
1. 获取股票近期日均换手率数据
2. 根据股票市值大小划分市值组别：
   - 特大盘：>1000亿
   - 超大盘：500-1000亿
   - 大盘：300-500亿
   - 中盘：100-300亿
   - 小盘：50-100亿
   - 微小盘A：20-50亿
   - 微小盘B：<20亿
3. 针对不同市值组别设置基准换手率
4. 根据行业特性调整基准换手率
5. 比较实际换手率与基准换手率，计算得分(0-100)

### 5. 估值分析

估值分析用于评估股票的估值水平，判断股票是否被高估或低估。

**计算步骤**：
1. 获取股票的PE(TTM)、PB、PS(TTM)和股息率等估值指标
2. 根据股票所属行业类型设置不同的估值指标权重：
   - 成长型行业：PE(TTM)(0.35)、PB(0.25)、PS(TTM)(0.30)、股息率(0.10)
   - 价值型行业：PE(TTM)(0.30)、PB(0.25)、PS(TTM)(0.15)、股息率(0.30)
   - 周期型行业：PE(TTM)(0.25)、PB(0.35)、PS(TTM)(0.25)、股息率(0.15)
3. 将各估值指标与行业平均水平比较，计算单项得分
4. 加权求和得到估值分析最终得分(0-100)

### 6. 历史估值分析

历史估值分析用于评估股票当前估值在历史上的位置，判断估值的合理性。

**计算步骤**：
1. 获取股票过去3年的估值数据(PE、PB、PS)
2. 计算当前估值在历史数据中的分位数
3. 根据分位数高低判断当前估值水平：
   - 极低估值：0-10%
   - 低估值：10-25%
   - 合理估值：25-75%
   - 高估值：75-90%
   - 极高估值：90-100%
4. 根据历史估值位置计算得分(0-100)

### 7. 财务健康度分析

财务健康度分析用于评估公司的财务状况，包括盈利能力、现金流状况和偿债能力。

**计算步骤**：
1. **盈利能力分析**：
   - 计算ROE(净资产收益率)和净利润同比增长率
   - 根据行业平均水平评估盈利能力
2. **现金流分析**：
   - 分析经营活动现金流净额与净利润的比例
   - 评估现金流的稳定性和充足性
3. **偿债能力分析**：
   - 计算资产负债率、流动比率和速动比率
   - 评估公司的偿债风险
4. 加权计算财务健康度综合得分(0-100)

### 8. RSI指标分析

RSI(Relative Strength Index)指标分析用于评估股票的超买超卖状态。

**计算步骤**：
1. 获取股票过去14个交易日的收盘价数据
2. 计算平均上涨日收益率和平均下跌日收益率
3. 计算RSI值：`RSI = 100 - (100 / (1 + (平均上涨收益率 / 平均下跌收益率)))`
4. 根据RSI值判断超买超卖状态：
   - 超买：RSI > 70
   - 正常：30 < RSI < 70
   - 超卖：RSI < 30
5. 根据RSI状态和数值计算得分(0-100)

## 安装步骤

1. 克隆项目
   ```bash
   git clone https://github.com/yourusername/financial-risk-analysis.git
   cd financial-risk-analysis
   ```

2. 安装依赖
   ```bash
   pip install -r requirements.txt
   ```

3. 启动应用
   ```bash
   python app_new.py
   ```

4. 访问应用
   打开浏览器访问 `http://127.0.0.1:5000`

## 使用说明

1. 在输入框中输入股票名称或代码
2. 点击"分析"按钮或按回车键
3. 等待分析结果
4. 查看主要分析结果和详细分析结果
5. 可以点击"生成风险分析报告"按钮生成完整报告

## 项目结构

```
.
├── agent.py              # 核心分析逻辑
├── app_new.py            # Flask应用入口
├── templates/
│   └── index_new.html    # 前端页面模板
├── cache/                # 缓存目录
├── reports/              # 生成的报告目录
├── requirements.txt      # 项目依赖
└── README.md             # 项目说明
```

## 核心功能

### 综合风险分析

综合考虑多个维度的风险指标，包括：
- 财务健康度
- 波动率
- 趋势强度
- 换手率
- 估值水平
- 历史估值分位
- RSI指标

### 报告生成

生成详细的Markdown格式报告，包括：
- 公司基本情况
- 分析框架与指标解读
- 财务健康度分析
- 波动率分析
- 趋势分析
- 换手率分析
- 估值分析
- 历史估值分析
- 综合风险结论

## 缓存机制

系统使用文件缓存来减少API调用次数，提高响应速度：
- 缓存有效期根据数据类型设置
- 缓存目录：`cache/`
- 缓存文件包括：
  - 行业信息
  - 历史数据
  - 流通市值
  - 财务数据
  - 分红率

## API与数据许可证

### baostock API
- **服务类型**：免费金融数据服务
- **许可证**：根据baostock官网说明，提供免费数据服务，具体使用条款请参考[baostock官网](http://baostock.com/)
- **数据范围**：历史行情、财务数据、宏观经济数据等
- **使用限制**：建议遵守baostock的使用规范，避免过度调用

### akshare API
- **服务类型**：开源金融数据接口库
- **许可证**：MIT License
- **GitHub仓库**：[akfamily/akshare](https://github.com/akfamily/akshare)
- **数据范围**：股票、基金、期货、期权、债券、宏观经济等多种金融数据
- **使用限制**：遵循MIT License，可自由使用和修改

### 数据使用注意事项
1. 本项目获取的数据仅供学习和研究使用
2. 商业使用前请确认相关API和数据的商业授权条款
3. 数据可能存在延迟或误差，仅供参考
4. 遵守各API提供商的使用限制和要求

## 开发流程

1. 代码开发
2. 运行测试脚本
3. 启动应用进行功能测试
4. 提交代码

## 本项目许可证

MIT License

## API接口说明

### 1. 股票风险分析接口

**接口URL**：`/analyze`

**请求方法**：POST

**请求参数**：
| 参数名 | 类型 | 必需 | 描述 | 示例 |
|--------|------|------|------|------|
| stock_input | string | 是 | 股票名称或代码 | "贵州茅台" 或 "600519" |

**响应格式**：
```json
{
  "success": true,
  "code": "600519",
  "basic_info": {
    "code": "600519",
    "name": "贵州茅台",
    "current_price": 1800.00,
    "change_percent": 2.50
  },
  "comprehensive_risk": {
    "risk_level": "低风险",
    "final_score": 85,
    "industry": "白酒",
    "sw_industry": "食品饮料"
  },
  "volatility_analysis": {
    "volatility_score": 80,
    "annualized_volatility": 18.5,
    "volatility_level": "低波动率"
  },
  "trend_analysis": {
    "trend_score": 90,
    "trend_status": "上升趋势",
    "trend_strength": "强"
  },
  "turnover_analysis": {
    "turnover_score": 75,
    "actual_turnover": 0.5,
    "benchmark_turnover": 0.4
  },
  "valuation_analysis": {
    "final_score": 80,
    "PE_TTM": 30.5,
    "PB": 10.2,
    "PS_TTM": 15.8,
    "dividend_yield": 1.5
  },
  "historical_valuation": {
    "final_score": 75,
    "current_valuation": {
      "PE_TTM": 30.5,
      "PB": 10.2,
      "PS_TTM": 15.8
    },
    "percentiles": {
      "PE_TTM": 70,
      "PB": 65,
      "PS_TTM": 75
    }
  },
  "financial_health": {
    "final_score": 90,
    "profitability_score": 95,
    "cashflow_score": 85,
    "solvency_score": 90
  },
  "rsi_analysis": {
    "rsi_score": 80,
    "rsi_value": 65,
    "rsi_status": "正常"
  }
}
```

### 2. 生成风险分析报告接口

**接口URL**：`/generate_report`

**请求方法**：POST

**请求参数**：
| 参数名 | 类型 | 必需 | 描述 | 示例 |
|--------|------|------|------|------|
| stock_input | string | 是 | 股票名称或代码 | "贵州茅台" 或 "600519" |

**响应格式**：
```json
{
  "success": true,
  "report_path": "reports/贵州茅台_600519_综合风险分析报告.md"
}
```

### 3. 错误码说明

| 错误码 | 描述 |
|--------|------|
| 400 | 请求参数错误 |
| 500 | 服务器内部错误 |
| 501 | 股票代码无效或未找到 |
| 502 | 第三方API调用失败 |

**错误响应示例**：
```json
{
  "success": false,
  "error": "分析失败: 无效的股票代码",
  "detail": "详细错误堆栈信息"
}
```

## 部署说明

### 使用PythonAnywhere部署

PythonAnywhere是一个免费的Python应用托管平台，适合部署小型Web应用。

#### 1. 准备工作
- 确保项目已上传到GitHub仓库
- 注册PythonAnywhere账号：[https://www.pythonanywhere.com](https://www.pythonanywhere.com)
- 获取GitHub仓库URL：登录GitHub → 进入仓库页面 → 点击绿色"Code"按钮 → 复制HTTPS URL

#### 2. 部署步骤

1. **登录PythonAnywhere**
   - 访问[PythonAnywhere官网](https://www.pythonanywhere.com)并登录

2. **创建Bash终端**
   - 点击顶部导航栏的"Consoles"
   - 选择"Bash"，打开一个新的终端窗口

3. **克隆GitHub仓库**
   ```bash
   git clone https://github.com/你的用户名/你的仓库名.git
   # 例如：git clone https://github.com/user/financial-risk-analysis.git
   ```

4. **进入项目目录**
   ```bash
   cd 你的仓库名
   # 例如：cd financial-risk-analysis
   ```

5. **创建并激活虚拟环境**
   ```bash
   # 创建虚拟环境
   python3 -m venv venv
   
   # 激活虚拟环境
   source venv/bin/activate
   ```

6. **安装项目依赖**
   ```bash
   pip install -r requirements.txt
   ```

7. **配置Web应用**
   - 点击顶部导航栏的"Web"
   - 点击"Add a new web app"
   - 在弹出的对话框中，点击"Next"
   - 选择"Flask"，然后点击"Next"
   - 选择Python版本（建议3.8或更高），然后点击"Next"
   - 输入应用入口文件路径：`你的用户名/你的仓库名/app_new.py`
   - 点击"Next"完成创建

8. **配置WSGI文件**
   - 在"Web"页面中，找到"Code"部分的"WSGI configuration file"链接，点击进入编辑器
   - 删除默认内容，替换为以下代码（修改为你的实际路径）：
     ```python
     import sys
     import os

     # 设置工作目录
     path = '/home/你的PythonAnywhere用户名/你的仓库名'
     if path not in sys.path:
         sys.path.append(path)

     # 设置环境变量
     os.chdir(path)

     # 导入Flask应用
     from app_new import app as application
     ```
   - 点击"Save"保存文件

9. **创建必要目录**
   - 在Bash终端中执行：
     ```bash
     mkdir -p reports cache
     ```

10. **重启Web应用**
    - 返回"Web"页面
    - 点击绿色的"Reload 你的用户名.pythonanywhere.com"按钮
    - 等待应用重启完成

#### 3. 访问应用
- 重启完成后，点击"Web"页面中的URL链接（格式：`你的用户名.pythonanywhere.com`）
- 浏览器会打开金融风险分析系统
- 尝试输入股票代码或名称，点击分析按钮，检查是否能正常生成分析结果

#### 4. 部署后维护

##### 更新代码
如果GitHub仓库代码有更新，需要：
```bash
# 在Bash终端中执行
cd /home/你的用户名/你的仓库名
git pull
# 重新安装依赖（如果有变化）
pip install -r requirements.txt
# 重启应用
# 点击"Web"页面中的"Reload"按钮
```

##### 查看日志
- **错误日志**：在"Web"页面 → "Logs" → "error log"，查看应用错误信息
- **访问日志**：在"Web"页面 → "Logs" → "access log"，查看应用访问记录

##### 查看资源使用情况
- 在"Account"页面可以查看剩余CPU时间和存储空间使用情况
- 免费计划每月1号自动重置500小时CPU时间

#### 5. 常见问题解决

1. **应用无法启动**
   - **症状**：访问应用时显示500错误
   - **解决方案**：检查错误日志，查看是否有依赖安装错误或代码语法错误
   - **操作**：在"Web"页面 → "Logs" → "error log"查看详细错误信息

2. **模板未找到**
   - **症状**：访问应用时显示"TemplateNotFound"错误
   - **解决方案**：确保templates文件夹路径正确，WSGI配置中的项目路径正确
   - **操作**：检查WSGI文件中的`path`变量是否指向正确的项目目录

3. **API调用失败**
   - **症状**：分析股票时显示"API调用失败"错误
   - **解决方案**：检查网络连接，确保PythonAnywhere可以访问外部API
   - **操作**：在Bash终端中执行`ping www.baidu.com`测试网络连接

4. **应用自动休眠**
   - **症状**：应用在30分钟无访问后自动休眠，下次访问时需要1-2秒唤醒时间
   - **解决方案**：这是免费计划的正常机制，无需解决
   - **说明**：休眠期间不消耗CPU时间，唤醒后可正常使用

5. **CPU时间用完**
   - **症状**：访问应用时显示"CPU time exceeded"错误
   - **解决方案**：等待下月1号CPU时间重置，或优化代码减少CPU消耗
   - **优化建议**：合理设置缓存，减少重复计算和API调用

## 联系方式

如有问题或建议，请联系项目维护者。